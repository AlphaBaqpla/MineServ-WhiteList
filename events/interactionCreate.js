//============INTEGRATION CREATE EVENT============
module.exports = {
    name: 'interactionCreate',
    async execute(interaction, client){
        const {MessageEmbed, MessageActionRow, MessageButton} = require('discord.js')
        const { Modal, TextInputComponent, showModal } = require('discord-modals')
        var conf = client.config
        if (!interaction.isButton()) return
        if (interaction.customId == "requestEmbed"){
            if (client.guilds.cache.get(interaction.guildId).channels.cache.find(c => c.topic == interaction.user.id)){
                return interaction.reply({
                    content: '–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∑–∞—è–≤–∫–∞!',
                    ephemeral: true
                })
            }
            interaction.guild.channels.create(`–∑–∞—è–≤–∫–∞-${interaction.user.username}`,{
                parent: client.config.requestParent,
                topic: interaction.user.id,
                permissionOverwrites: [{
                    id: interaction.user.id,
                    allow: ['SEND_MESSAGES', 'VIEW_CHANNEL'],
                  },
                  {
                    id: client.config.adminRole,
                    allow: ['SEND_MESSAGES', 'VIEW_CHANNEL'],
                  },
                  {
                    id: interaction.guild.roles.everyone,
                    deny: ['VIEW_CHANNEL'],
                  },
                ],
                type: 'text'
            }).then(async c => {
                const sendChannel = client.channels.cache.get(c.id)
                interaction.reply({
                    content: `–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É! <#${c.id}>`,
                    ephemeral: true
                })
                const embed = new MessageEmbed()
                .setColor('#00ffe1')
                .setAuthor(
                    {
                        name: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ê–Ω–∫–µ—Ç—É'
                    })
                .setDescription('**–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –¥–ª—è –≤—Ö–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!**')
                .setThumbnail(client.config.thumbImage)
                .setFooter(
                    {
                        text: client.config.footerText
                    })
                const row = new MessageActionRow()
                .addComponents(
                    new MessageButton()
                        .setCustomId('requestChanEmbed')
                        .setLabel('–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ê–Ω–∫–µ—Ç—É')
                        .setEmoji('üí´')
                        .setStyle('SUCCESS')
                        )
                    sendChannel.send(
                        {
                            embeds: [embed],
                            components: [row]
                        }
                    )
                }
            ).catch(e =>{console.log(e)})
        }
        const reqModal = new Modal()
        .setCustomId('requestModal')
        .setTitle('–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ê–Ω–∫–µ—Ç—É')
        .addComponents(
            new TextInputComponent()
            .setCustomId('nickInput')
            .setLabel('–≤–∞—à –Ω–∏–∫–Ω–µ–π–º')
            .setStyle('SHORT')
            .setPlaceholder('–Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –Ω–∏–∫–Ω–µ–π–º –≤ Minecraft')
            .setRequired(true),
            new TextInputComponent()
            .setCustomId('nameInput')
            .setLabel('–≤–∞—à–µ –∏–º—è / –≤–æ–∑—Ä–∞—Å—Ç')
            .setStyle('SHORT')
            .setPlaceholder('–Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –∏ –≤–æ–∑—Ä–∞—Å—Ç')
            .setRequired(true),
            new TextInputComponent()
            .setCustomId('cheatsInput')
            .setLabel('–∫–∞–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ —á–∏—Ç–∞–º')
            .setStyle('SHORT')
            .setPlaceholder('–Ω–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ —á–∏—Ç–∞–º')
            .setRequired(true),
            new TextInputComponent()
            .setCustomId('findInput')
            .setLabel('–∫–∞–∫ –≤—ã —É–∑–Ω–∞–ª–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ')
            .setStyle('SHORT')
            .setPlaceholder('–Ω–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –≤—ã —É–∑–Ω–∞–ª–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ')
            .setRequired(true),
            new TextInputComponent()
            .setCustomId('buildInput')
            .setLabel('—á—Ç–æ –≤—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –¥–µ–ª–∞—Ç—å')
            .setStyle('LONG') //'SHORT' or 'LONG'
            .setPlaceholder('–Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –¥–µ–ª–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ')
            .setRequired(true)
            )
            if (!interaction.isButton()) return
            if (interaction.customId == "requestChanEmbed"){
                showModal(reqModal, {
                    client: client,
                    interaction: interaction
                }
            )   
        }

        const admin = '<@'+interaction.user.id+'>'
        const nickname = interaction.channel.topic
        
        if (interaction.customId == "addPlayer"){
            if(interaction.member.permissions.has("ADMINISTRATOR")){
                interaction.reply({
                    content: '**–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞ –∞–¥–º–∏–Ω–æ–º '+admin+' –∏ –∏–≥—Ä–æ–∫ "'+nickname+'" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞–π—Ç–ª–∏—Å—Ç!**'
                })
                const Rcon = require('rcon')
                const o = {tcp:true,challenge:false}
                const conn = new Rcon(conf.RCon.IP, conf.RCon.Port, conf.RCon.Password, o)
                conn.on('auth', function(){
                  var cmd = conf.WhiteList.addCommand.replaceAll('$user',nickname)
                    console.log("Authenticated")
                    console.log("Sending command: "+cmd)
                    conn.send(cmd)
                }).on('response', function(str){
                    console.log("Response: " + str)
                    conn.disconnect()
                }).on('error', function(err){
                    console.log("Error: " + err)
                }).on('end', function(){
                    console.log("Connection closed")
                })
                conn.connect()
                console.info('–ò–≥—Ä–æ–∫ "'+nickname+'" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞–π—Ç–ª–∏—Å—Ç')
                //var role = message.guild.roles.cache.find(role => role.id === conf.playerRole);
                //var user = message.guild.members.cache.get('');
                //user.roles.add(role)
            }
            else{
                interaction.reply({
                    content: '**–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏!**',
                    ephemeral: true
                })
            }
        }

        if (interaction.customId == "removePlayer"){
            if(interaction.member.permissions.has("ADMINISTRATOR") || interaction.user.id == '993970004615757906'){
                interaction.reply({
                    content: '**–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ '+admin+' –∏ –∏–≥—Ä–æ–∫ "'+nickname+'" —É–¥–∞–ª—ë–Ω –∏–∑ –≤ –≤–∞–π—Ç–ª–∏—Å—Ç–∞!**',
                })
                const Rcon = require('rcon')
                const o = {tcp:true,challenge:false}
                const conn = new Rcon(conf.RCon.IP, conf.RCon.Port, conf.RCon.Password, o)
                conn.on('auth', function(){
                  var cmd = conf.WhiteList.remCommand.replaceAll('$user',nickname)
                    console.log("Authenticated")
                    console.log("Sending command: "+cmd)
                    conn.send(cmd)
                }).on('response', function(str){
                    console.log("Response: " + str)
                    conn.disconnect()
                }).on('error', function(err){
                    console.log("Error: " + err)
                }).on('end', function(){
                    console.log("Connection closed")
                })
                conn.connect()
                console.info('–ò–≥—Ä–æ–∫ "'+nickname+'" —É–¥–∞–ª—ë–Ω –∏–∑ –í–õ')
            }
            else{
                interaction.reply({
                    content: '**–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏!**',
                    ephemeral: true
                })
            }
        }
        if (interaction.customId == "deleteChan"){
            const embed = new MessageEmbed()
                .setColor('#00ffe1')
                .setAuthor({
                    name: '–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏!'
                })
                .setDescription('**–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å!**')
                .setThumbnail(client.config.thumbImage)
                .setFooter({
                    text: client.config.footerText
                })
            const row = new MessageActionRow()
            .addComponents(
                new MessageButton()
                .setCustomId('not')
                .setLabel('–æ—Ç–º–µ–Ω–∏—Ç—å')
                .setEmoji('üíö')
                .setStyle('SUCCESS'),
                new MessageButton()
                .setCustomId('yes')
                .setLabel('—É–¥–∞–ª–∏—Ç—å')
                .setEmoji('‚ù§Ô∏è')
                .setStyle('DANGER'),
            )
            interaction.reply({
                embeds: [embed],
                components: [row]
            })
        }
        if (interaction.customId == "not"){
            const embed = new MessageEmbed()
            .setColor('#00ffe1')
            .setAuthor({
                name: '—É–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ!'
            })
            .setDescription('**–º—è—É!**')
            .setThumbnail(client.config.thumbImage)
            .setFooter({
                text: client.config.footerText
            })
            interaction.reply({
                embeds: [embed]
            })
        }
        if (interaction.customId == "yes"){
            const embed = new MessageEmbed()
            .setColor('#00ffe1')
            .setAuthor({
                name: '–∑–∞—è–≤–∫–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥!'
            })
            .setDescription('**–≠—Ö, –ø—Ä–æ—â–∞–π, –º—ã —Å —Ç–æ–±–æ–π –±–æ–ª—å—à–µ –Ω–µ —É–≤–∏–¥–∏–º—Å—è (–Ω–æ —ç—Ç–æ –Ω–µ —Ç–æ—á–Ω–æ)**')
            .setThumbnail(client.config.thumbImage)
            .setFooter({
                text: client.config.footerText
            })
            interaction.reply({
                embeds: [embed]
            })
            setTimeout(() => {
                const delChan = client.channels.cache.get(interaction.channel.id)
                delChan.delete()
            }, 10000)
        }
    }
}